# 1 介绍一下 SPI

SPI，全称是**Service Provider Interface**，即服务提供者接口。它是Java提供的一套用来被第三方实现或者扩展的API，它可以用来启用框架扩展和组件化。SPI机制实际上是“基于接口的编程＋策略模式＋配置文件”的组合。

在Java SPI中，存在服务接口（Service Interface）、服务提供者（Service Provider）、服务提供者接口（Service Provider Interface，SPI）和服务配置文件（Service Configuration File）这几个核心要素。

- **服务接口**：这是业务方定义的接口，它定义了业务方希望获取的服务内容。
- **服务提供者**：服务提供者实现了服务接口，并对外提供服务。一个服务接口可以有多个服务提供者实现。
- **服务提供者接口（SPI）**：这是一个标记接口，没有任何方法，它的目的是告诉实现类这是一个服务提供者。Java SPI要求服务提供者实现类所在的jar包的META-INF/services目录下有一个以服务接口全限定名为文件名的文件，该文件的内容是实现类的全限定名。
- **服务配置文件**：在服务提供者jar包的META-INF/services目录下，有一个以服务接口全限定名为文件名的文件，该文件的内容是实现类的全限定名列表。

Java SPI的加载过程大致如下：

1. 服务接口定义业务方需要的功能。
2. 服务提供者实现服务接口，并发布到classpath下。
3. 服务使用方通过ServiceLoader加载服务，并调用服务。

Java SPI的优势在于它使得第三方服务模块的装配控制的逻辑与调用者的业务代码分离，提高了程序的可扩展性。同时，Java SPI也是很多框架（如Dubbo、JDBC等）扩展机制的核心。

需要注意的是，Java SPI在查找服务提供者时，采用的是“全限定类名”作为查找依据，因此服务提供者接口的全限定名必须与服务配置文件中定义的接口全限定名一致，否则Java SPI将无法正确加载服务提供者。

# 2 SPI 和 API 有什么区别？

SPI（Service Provider Interface）和API（Application Programming Interface）都是用于软件开发和组件交互的接口，但它们之间存在一些关键区别。

1. 定义和用途：
   - SPI是一种服务提供者接口，它定义了一组用于实现特定服务的接口或抽象类。它主要用于定义和扩展接口，允许第三方实现具体功能。SPI允许多个不同的实现提供相同的功能，从而使得软件模块在运行时可以动态地选择和加载不同的实现。SPI广泛应用于Java的核心库和许多第三方库中，以支持可插拔的组件和服务。
   - API是一种应用程序编程接口，它定义了一组用于与特定软件组件或服务进行交互的函数、方法和数据结构。API为开发人员提供了一种抽象层，使得他们可以在不了解底层实现细节的情况下，利用和构建复杂的软件系统。API可以是一种语言绑定的库（例如Java或Python的API），也可以是一种通用的网络协议（例如RESTful API或GraphQL API）。
2. 调用和实现方式：
   - SPI是一种回调的思想，回调是指我们在使用API时，可以向API传入一个类或者方法，API在合适的时间调用类或者方法。SPI是在一些通用的标准中，为标准的实现产商提供的扩展点。标准在上层提供API，API内部使用了SPI，当API被客户使用时，会动态从当前运行的classpath中寻找该SPI的实现，然后使用该SPI的实现来完成API的功能。
   - API直接为开发人员提供功能，使用API就能完成任务。API定义了一组方法、类和协议，允许开发人员使用特定的代码来与软件或服务进行交互。
3. 加载时机：
   - SPI一般在运行时进行加载和发现，它允许软件模块在运行时动态地选择和加载不同的实现。
   - API可以在编译时或运行时被调用。
